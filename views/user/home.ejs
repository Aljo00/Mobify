<%- include('../../views/layout/header.ejs') %>

<!-- Bootstrap CSS -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<!-- Font Awesome -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
/>
<!-- Custom CSS -->
<link rel="stylesheet" href="/styles/user/home.css" />

<!-- Navbar -->
<nav class="navbar navbar-expand-lg shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand fw-bold text-primary" href="/">Mobify</a>
    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarNav"
    >
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link active" href="/">Home</a></li>
        <li class="nav-item dropdown">
          <a
            class="nav-link"
            href="#"
            id="navbarDropdown"
            role="button"
            aria-expanded="false"
          >
            Brands
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
            <% for (let i = 0; i < brand.length; i++) { %>
            <li>
              <a class="dropdown-item" href="#"><%= brand[i].brandName %></a>
            </li>
            <% } %>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/aboutus">About Us</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/contactus">Contact Us</a>
        </li>
      </ul>
      <form class="d-flex me-3" method="get">
        <div class="input-group">
          <input
            class="form-control"
            type="search"
            name="search"
            placeholder="Search products..."
          />
          <button class="input-group-text search-icon" type="submit">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </form>
      <div class="icons-group me-2">
        <a href="#" class="text-dark me-3"><i class="far fa-heart fs-5"></i></a>
        <a href="/cart" class="text-dark position-relative">
          <i class="fas fa-shopping-cart fs-5"></i>
          <% if (cartItemCount && cartItemCount > 0) { %>
          <span
            class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
          >
            <%= cartItemCount %>
          </span>
          <% } %>
        </a>
      </div>
      <% if (locals.user) {%>
      <div class="dropdown">
        <a href="#" class="sign-in-link">
          <i class="fas fa-user-circle"></i> <%=locals.user.name%>
        </a>
        <div class="dropdown-content">
          <a href="/account">Profile</a>
          <a href="/addresses">Address</a>
          <a href="/logout">logout</a>
        </div>
      </div>
      <%} else {%>
      <div class="d-flex align-items-center">
        <a
          href="/login"
          class="btn btn-primary text-primary bg-white border-primary me-2"
          >Login</a
        >
        <a
          href="/signup"
          class="btn btn-primary text-primary bg-white border-primary"
          >Sign Up</a
        >
      </div>
      <%}%>
    </div>
  </div>
</nav>

<!-- Main Content -->
<main class="container py-5 text-center">
  <!-- Banner Section -->
  <div id="bannerCarousel" class="carousel slide mb-5" data-bs-ride="carousel">
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img
          src="/Banner Images/Banner.1.webp"
          class="d-block w-100"
          alt="Custom Banner 1"
        />
      </div>
      <div class="carousel-item">
        <img
          src="/Banner Images/Banner2.webp"
          class="d-block w-100"
          alt="Custom Banner 2"
        />
      </div>
      <div class="carousel-item">
        <img
          src="/Banner Images/Banner3.webp"
          class="d-block w-100"
          alt="Custom Banner 3"
        />
      </div>
    </div>
    <button
      class="carousel-control-prev"
      type="button"
      data-bs-target="#bannerCarousel"
      data-bs-slide="prev"
    >
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button
      class="carousel-control-next"
      type="button"
      data-bs-target="#bannerCarousel"
      data-bs-slide="next"
    >
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>

  <div class="row">
    <div class="col-lg-3">
      <div class="section-title-wrapper">
        <i class="fas fa-star"></i>
        <h3 class="section-title">New Arrivals</h3>
      </div>
    </div>
  </div>
  <div class="product__filter-wrapper">
    <div class="product__filter d-flex overflow-auto">
      <% for (let i = 0; i < newArrivals.length; i++) { %>
      <div class="col-lg-2 col-md-3 col-sm-4 col-6 mix new-arrivals">
        <div class="product__item compact">
          <a href="/product/<%= newArrivals[i]._id %>">
            <div
              class="product__item__pic"
              style="
                background-image: url('<%= newArrivals[i].productImage[0] %>');
              "
            >
              <img
                src="<%= newArrivals[i].productImage[1] %>"
                class="hover-image"
                alt="Second Image"
              />
              <div
                class="product-category <%= newArrivals[i].category === 'New Phone' ? 'new-phone' : 'refurbished' %>"
              >
                <%= newArrivals[i].category === 'New Phone' ? 'New Phone' :
                'Refurbished' %>
              </div>
            </div>
          </a>
          <div class="product__item__text">
            <h6 class="product-name"><%= newArrivals[i].productName %></h6>
            <h5 class="product-price">
              ₹<%= newArrivals[i].combos[0].salePrice.toLocaleString() %>
              <span class="text-muted">
                <del
                  >₹<%= newArrivals[i].combos[0].regularPrice.toLocaleString()
                  %></del
                >
              </span>
              <% if (newArrivals[i].combos[0].regularPrice >
              newArrivals[i].combos[0].salePrice) { %>
              <span class="product-discount">
                -<%= Math.round(((newArrivals[i].combos[0].regularPrice -
                newArrivals[i].combos[0].salePrice) /
                newArrivals[i].combos[0].regularPrice) * 100) %>%
              </span>
              <% } %>
            </h5>
            <div class="action-buttons">
              <a
                href="/addToCart?id=<%= newArrivals[i]._id %>"
                class="add-cart"
                data-id="<%= newArrivals[i]._id %>"
              >
                Add To Cart</a
              >
              <a
                href="/addToWishlist?id=<%= newArrivals[i]._id %>"
                class="wishlist-btn"
              >
                <i class="fa fa-heart"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
      <% } %>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-3">
      <div class="section-title-wrapper">
        <i class="fas fa-mobile-alt"></i>
        <h3 class="section-title">New Phones</h3>
      </div>
    </div>
  </div>
  <div class="product__filter-wrapper">
    <div class="product__filter d-flex overflow-auto">
      <% for (let i = 0; i < newPhones.length; i++) { %>
      <div class="col-lg-2 col-md-3 col-sm-4 col-6 mix new-arrivals">
        <div class="product__item compact">
          <a href="/product/<%= newPhones[i]._id %>">
            <div
              class="product__item__pic"
              style="
                background-image: url('<%= newPhones[i].productImage[0] %>');
              "
            >
              <img
                src="<%= newPhones[i].productImage[1] %>"
                class="hover-image"
                alt="Second Image"
              />
            </div>
          </a>
          <div class="product__item__text">
            <h6 class="product-name"><%= newPhones[i].productName %></h6>
            <h5 class="product-price">
              ₹<%= newPhones[i].combos[0].salePrice.toLocaleString() %>
              <span class="text-muted">
                <del
                  >₹<%= newPhones[i].combos[0].regularPrice.toLocaleString()
                  %></del
                >
              </span>
              <% if (newPhones[i].combos[0].regularPrice >
              newPhones[i].combos[0].salePrice) { %>
              <span class="product-discount">
                -<%= Math.round(((newPhones[i].combos[0].regularPrice -
                newPhones[i].combos[0].salePrice) /
                newPhones[i].combos[0].regularPrice) * 100) %>%
              </span>
              <% } %>
            </h5>
            <div class="action-buttons">
              <a
                href="/addToCart?id=<%= newPhones[i]._id %>"
                class="add-cart"
                data-id="<%= newPhones[i]._id %>"
                >Add To Cart</a
              >
              <a
                href="/addToWishlist?id=<%= newPhones[i]._id %>"
                class="wishlist-btn"
              >
                <i class="fa fa-heart"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
      <% } %>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-3">
      <div class="section-title-wrapper">
        <i class="fas fa-sync-alt"></i>
        <h3 class="section-title">Refurbished Phones</h3>
      </div>
    </div>
  </div>
  <div class="product__filter-wrapper">
    <div class="product__filter d-flex overflow-auto">
      <% for (let i = 0; i < refurbishedPhones.length; i++) { %>
      <div class="col-lg-2 col-md-3 col-sm-4 col-6 mix new-arrivals">
        <div class="product__item compact">
          <a href="/product/<%= refurbishedPhones[i]._id %>">
            <div
              class="product__item__pic"
              style="
                background-image: url('<%= refurbishedPhones[i].productImage[0] %>');
              "
            >
              <img
                src="<%= refurbishedPhones[i].productImage[1] %>"
                class="hover-image"
                alt="Second Image"
              />
            </div>
          </a>
          <div class="product__item__text">
            <h6 class="product-name">
              <%= refurbishedPhones[i].productName %>
            </h6>
            <h5 class="product-price">
              ₹<%= refurbishedPhones[i].combos[0].salePrice.toLocaleString() %>
              <span class="text-muted">
                <del
                  >₹<%=
                  refurbishedPhones[i].combos[0].regularPrice.toLocaleString()
                  %></del
                >
              </span>
              <% if (refurbishedPhones[i].combos[0].regularPrice >
              refurbishedPhones[i].combos[0].salePrice) { %>
              <span class="product-discount">
                -<%= Math.round(((refurbishedPhones[i].combos[0].regularPrice -
                refurbishedPhones[i].combos[0].salePrice) /
                refurbishedPhones[i].combos[0].regularPrice) * 100) %>%
              </span>
              <% } %>
            </h5>
            <div class="action-buttons">
              <a
                href="/addToCart?id=<%= refurbishedPhones[i]._id %>"
                class="add-cart"
                data-id="<%= refurbishedPhones[i]._id %>"
                >Add To Cart</a
              >
              <a
                href="/addToWishlist?id=<%= refurbishedPhones[i]._id %>"
                class="wishlist-btn"
              >
                <i class="fa fa-heart"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
      <% } %>
    </div>
  </div>
</main>

<!-- Footer -->
<footer class="container-fluid">
  <div class="text-center">
    <p class="mb-0">&copy; 2023 Mobify. All rights reserved.</p>
  </div>
</footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Store the scroll position when the page is about to reload
    window.onbeforeunload = () => {
      sessionStorage.setItem("scrollPosition", window.scrollY);
    };

    const addCartButtons = document.querySelectorAll(".add-cart");

    addCartButtons.forEach((button) => {
      button.addEventListener("click", async (event) => {
        event.preventDefault();

        const productId = button.getAttribute("data-id");
        const url = `/addToCart?id=${productId}`;

        try {
          const response = await fetch(url, { method: "GET" });
          const data = await response.json();

          if (data.success) {
            Swal.fire({
              icon: "success",
              title: "Added to Cart",
              text: data.message,
              toast: true,
              position: "top-end",
              showConfirmButton: false,
              timer: 1000,
              timerProgressBar: true,
              background: "#d4edda",
              color: "#155724",
            }).then(() => {
              // Refresh the page after success
              window.location.href = window.location.href;
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: data.message || "An error occurred while adding to cart.",
              toast: true,
              position: "top-end",
              showConfirmButton: false,
              timer: 1500,
              timerProgressBar: true,
              background: "#f8d7da",
              color: "#721c24",
            }).then(() => {
              // Refresh the page after error
              window.location.href = window.location.href;
            });
          }
        } catch (error) {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: data.message || "An error occurred while adding to cart.",
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 1500,
            timerProgressBar: true,
            background: "#f8d7da",
            color: "#721c24",
          }).then(() => {
            // Refresh the page after error
            window.location.href = window.location.href;
          });
          console.error(error);
        }
      });
    });

    // Restore the scroll position after the page reloads
    const previousScrollPosition = sessionStorage.getItem("scrollPosition");
    if (previousScrollPosition) {
      window.scrollTo({
        top: previousScrollPosition,
        behavior: "smooth", // Smooth scroll to the saved position
      });
    }
  });
</script>

<%- include('../../views/layout/footer.ejs') %>
