<%- include('../../views/layout/header.ejs') %>

<!-- Bootstrap CSS -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<!-- Font Awesome -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
/>

<link rel="stylesheet" href="/styles/user/orders.css" />

<div class="container-fluid mt-5">
  <!-- Breadcrumbs -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item active" aria-current="page">Orders</li>
    </ol>
  </nav>
  <div class="row">
    <div class="col-md-3">
      <div class="list-group">
        <a href="/account" class="list-group-item list-group-item-action">
          <i class="fas fa-user icon-img"></i> Account
        </a>
        <a href="/addresses" class="list-group-item list-group-item-action">
          <i class="fas fa-map-marker-alt icon-img"></i> Address
        </a>
        <a href="/orders" class="list-group-item list-group-item-action active">
          <i class="fas fa-box icon-img"></i> Orders
        </a>
        <a href="#" class="list-group-item list-group-item-action">
          <i class="fas fa-heart icon-img"></i> Wishlist
        </a>
        <a href="/wallet" class="list-group-item list-group-item-action">
          <i class="fas fa-wallet icon-img"></i> Wallet
        </a>
        <a href="#" class="list-group-item list-group-item-action">
          <i class="fas fa-key icon-img"></i> Reset Password
        </a>
        <a href="/logout" class="list-group-item list-group-item-action">
          <i class="fas fa-sign-out-alt icon-img"></i> Logout
        </a>
      </div>
    </div>
    <div class="col-md-9">
      <h2>My Orders</h2>
      <div class="order-cards">
        <% orders.forEach(order => { %> 
          <div class="order-card mb-4 position-relative p-3 shadow-sm rounded">
            <div class="order-products bg-light p-3 rounded mb-3">
              <% order.orderedItems.forEach(item => { %>
                <div class="order-item d-flex mb-3">
                  <div class="order-item-image me-3">
                    <img src="<%= item.product.productImage[0] %>" class="img-fluid rounded" alt="Product Image">
                  </div>
                  <div class="order-item-details flex-grow-1">
                    <h5 class="card-title"><a href="/orders/<%= item.orderId %>?productId=<%= item._id %>"><%= item.product.productName %></a></h5>
                    <p class="card-text">Unit Price: ₹<%= item.price %></p>
                    <p class="card-text">Quantity: <%= item.quantity %></p>
                    <p class="card-text">Total Price: ₹<%= item.totalPrice %></p>
                  </div>
                </div>
                <div class="order-status-bar">
                  <div class="status-step <%= item.status === 'Pending' || item.status === 'Processing' || item.status === 'Shipped' || item.status === 'Delivered' ? 'active' : '' %>">
                    <i class="fas fa-box"></i> Pending
                  </div>
                  <div class="status-step <%= item.status === 'Processing' || item.status === 'Shipped' || item.status === 'Delivered' ? 'active' : '' %>">
                    <i class="fas fa-cogs"></i> Processing
                  </div>
                  <div class="status-step <%= item.status === 'Shipped' || item.status === 'Delivered' ? 'active' : '' %>">
                    <i class="fas fa-truck"></i> Shipped
                  </div>
                  <div class="status-step <%= item.status === 'Delivered' ? 'active' : '' %>">
                    <i class="fas fa-check"></i> Delivered
                  </div>
                </div>
              <% }) %> 
            </div>
            <div class="order-address bg-white p-3 rounded mb-3">
              <i class="fas fa-map-marker-alt"></i> 
              <%= order.address.houseName %>, 
              <%= order.address.city %>, 
              <%= order.address.state %> - 
              <%= order.address.pincode %>
            </div>
            <div class="order-status-cancel d-flex justify-content-between align-items-center bg-light p-3 rounded">
              <span class="order-status badge bg-warning text-dark"><%= order.orderedItems[0].status %></span>
              <button 
                class="btn btn-danger btn-sm" 
                <% if (order.orderedItems[0].status === 'Shipped' || order.orderedItems[0].status === 'Delivered') { %> 
                  disabled 
                <% } %>
                onclick="cancelOrder('<%= order._id %>')"
              >
                Cancel Order
              </button>
            </div>
          </div>
        <% }) %>
      </div>
    </div>
  </div>
</div>

<script>
  function cancelOrder(orderId) {
    fetch('/cancel-order', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ orderId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Order cancelled successfully');
        location.reload(); // Reload the page to reflect the changes
      } else {
        alert('Failed to cancel order');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while cancelling the order');
    });
  }
</script>

<%- include('../../views/layout/footer.ejs') %>